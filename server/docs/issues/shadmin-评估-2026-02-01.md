# shadmin 安全与工程化评估：优先修复建议与里程碑

评分：6.0/10（Go + ent + React/Vite 单体架构）

## 概览
- 亮点：分层清晰（bootstrap/api/domain/usecase/repository/ent）、生成流程规范（swag/ent go:generate）、RBAC 钩子、前后端统一打包。
- 风险：默认敏感值写入 .env、弱口令、缺少测试与健康检查、容器安全基线欠缺。

## 详细问题与建议

### 1) 秘密管理与默认值（高风险）
- 问题：`bootstrap/env.go` 硬编码默认敏感值（`ADMIN_PASSWORD=123`、JWT secrets、MinIO `S3_ACCESS_KEY/S3_SECRET_KEY`），并会自动生成到 `.env`。
- 建议：
  - 移除默认敏感值；默认仅生成 `.env.example`（开发样例），不自动写真实 `.env`。
  - 生产必须从环境变量/密钥管理注入；在 `NewEnv()` 拒绝弱口令与默认密钥（长度、复杂度校验）。

### 2) 账户与权限安全
- 建议：首次管理员强口令/一次性令牌；登录速率限制与失败锁定；完善审计日志（登录、权限变更、资源访问）。

### 3) 配置与启动自检
- 建议：启动自检 DB/存储联通性与迁移状态；失败拒绝启动。
- 将 `ContextTimeout` 统一在仓储/外部访问层拦截，避免漏设。

### 4) 测试与 CI（当前缺失）
- 现状：仓库无 `*_test.go` 实测文件。
- 建议：为认证、RBAC、字典/菜单、文件存储补最小测试集（覆盖率≥60% 起步）。
- 配置 CI（GitHub Actions/Drone）跑 `lint`、`vet`、`test`，并在 Docker 构建前执行 `go generate` 一致性校验。

### 5) Docker 与构建
- 建议：
  - 构建阶段改用 `go mod download`（避免 `tidy` 改动依赖）。
  - 生产镜像不包含 `.env.example`；增加 `/healthz` 健康探针；容器以非 root 运行。

### 6) 安全基线
- 建议：配置 CORS/CSRF；上传校验（类型、大小、可选病毒扫描）。
- Swagger 在生产需鉴权或单独端口；禁用 `/debug/pprof`。

## 短期里程碑
- 一周内：
  - 移除默认敏感值与自动 `.env` 写入。
  - 强制生产外部配置；增加最小测试集与登录速率限制。
- 一月内：
  - 完善 RBAC 审计、健康检查、CI、安全基线；补充前端 E2E/单测。

## 依据与路径
- 代码：`bootstrap/env.go`（默认值与 `.env` 生成）；`cmd/main.go` 启动流程；`Dockerfile` 多阶段构建；仓库无 `*_test.go`。
- 技术栈：Go/ent/Swagger/Vite；端口默认 `55667`。

---
此评估由代码快速审阅产生，欢迎讨论与补充。建议以安全修复为先，随后补齐工程化与测试。