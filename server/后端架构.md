# 后端架构

## 技术栈与总体设计
- Web 框架：Gin（`api/` 路由与控制器）
- 数据访问：Ent ORM（`ent/`，启动时自动迁移）
- 鉴权与授权：JWT（访问/刷新令牌）+ Casbin RBAC（`internal/casbin/`）
- 配置管理：Viper（`.env` 自动生成与加载，见 `bootstarp/env.go`）
- 文档：Swagger（`go:generate swag init`，见 `main.go`）

## 目录与分层
- 表现层（HTTP）：`api/route`（按 Public/Protected 分组，集中中间件）、`api/controller`（业务入口）
- 应用层（用例）：`usecase/`（超时控制、编排领域逻辑）
- 领域层（模型/契约）：`domain/`（DTO、接口、常量、分页/响应包装）
- 基础设施层：`repository/`（Ent 仓储、文件存储实现）、`ent/`（生成代码）
- 启动装配：`bootstarp/`（应用实例、DB/存储/Casbin 初始化、种子数据）
- 横切：`api/middleware`（日志、JWT、Casbin）、`pkg/`（日志等工具）、`internal/`（安全、token 工具）

## 启动流程（`main.go` → `cmd.Run`）
1. `bootstrap.App()`：加载 `.env`、连接数据库、初始化 Casbin、文件存储、创建 Gin 引擎。
2. `api.SetupRoutes(app)`：注册静态资源与 Swagger，装配 API 路由。
3. `bootstrap.InitApiResources(app)`：扫描 Gin 路由落库（稳定 ID：`METHOD:/path`）。
4. `bootstrap.InitDefaultAdmin(app)`：初始化 `admin` 角色与用户、绑定菜单与策略。
5. `api.Run(app)`：监听端口（默认 `:55667`）。

## 请求处理链路
- 示例：`GET /api/v1/system/user`
  - Gin 路由（`api/route`）→ 中间件：请求日志（dev）、JWT（设置用户上下文）、Casbin（按 `path + method` 校验）→ 控制器（`api/controller`）→ 用例（`usecase`）→ 仓储（`repository` via Ent）→ `domain.Response` 统一返回。

## 鉴权与授权
- 认证：`api/middleware/jwt_auth_middleware.go` 校验并注入 `x-user-*` 上下文。
- 授权：`api/middleware/casbin_middleware.go` 调用 `Casbin.Manager.CheckPermission(userID, path, method)`。
- 白名单：公开与基础保护路径见 `internal/constants/api_paths.go`（公开、基本保护、Swagger）。

## 数据存储与迁移
- DB：默认 SQLite（`.database/data.db`），可切换 Postgres（`DB_TYPE=postgres`，`DB_DSN=...`）。
- 迁移：应用启动自动迁移（`ent/migrate`），当前开启 `WithDropIndex/WithDropColumn`，生产需谨慎。

## API 资源与菜单绑定
- 扫描：`bootstarp/api_resources_init.go` 遍历 Gin 路由，跳过公开/Swagger 路径，生成 `api_resources`。
- 绑定：`bootstarp/admin_init.go` 初始化菜单；按钮菜单通过 `AddAPIResourceIDs("METHOD:/api/v1/...")` 绑定接口；`admin` 角色默认 `*:*` 权限。

## 文件存储抽象
- 接口：`domain.FileRepository`
- 实现：本地磁盘（`repository/disk_file_repository.go`）与 MinIO（`repository/minio_file_repository.go`）可切换（`STORAGE_TYPE=disk|minio`）。

## 安全与可观测性
- 登录安全：`internal/login_security.go` 提供失败次数限制与临时锁定。
- 日志：`pkg/logger.go`（Logrus + 轮转，`.logs/`），开发态请求/响应日志中间件（`api/middleware/log_middleware.go`）。

